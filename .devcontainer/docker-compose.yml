---
#version: '3'
services:
  # Update this to the name of the service you want to work with in your docker-compose.yml file
  #app:
    # Uncomment if you want to override the service's Dockerfile to one in the .devcontainer 
    # folder. Note that the path of the Dockerfile and context is relative to the *primary* 
    # docker-compose.yml file (the first in the devcontainer.json "dockerComposeFile"
    # array). The sample below assumes your primary file is in the root of your project.
    #
    # build:
    #   context: .
    #   dockerfile: .devcontainer/Dockerfile
    #
    # volumes:
    #   Update this to wherever you want VS Code to mount the folder of your project
    #   - ..:/workspaces:cached
    #
    # Overrides default command so things don't shut down after the process ends.
    # command: /bin/sh -c "while sleep 1000; do :; done"
    #
    # Uncomment the next four lines if you will use a ptrace-based debugger like C++, Go, and Rust.
    # cap_add:
    #   - SYS_PTRACE
    # security_opt:
    #   - seccomp:unconfined

  dev-web:
    profiles: [dev]
    build:
      context: .
      cache_from:
        - docker-glftpd-web:latest
      dockerfile: Dockerfile
      # uncomment to set port, auth mode, htpasswd etc
      # args:
      #   - WEBUI_PORT=4043
      #   - WEBUI_AUTHMODE=basic
      #   - WEBUI_USERNAME=notshit
      #   - WEBUI_PASSWORD=Othersh1ttyPass
      #extra_hosts: ["host.docker.internal:host-gateway"]
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./etc/nginx/http.d:/etc/nginx/http.d:cached
      - ./etc/nginx/auth.d:/etc/nginx/auth.d:cached
      - ./src/ui:/app:cached
      - ./src/auth:/auth:cached
      - ./lib/ui:/app/lib:cached
      - ./lib/auth:/auth/lib:cached
      - ./templates:/app/templates:cached
      - ./assets:/app/assets:cached
      # use local gldir
      #- /jail/glftpd:/glftpd:cached
      # (TEST) use systemd from host
      #- /run:/host-run
    environment:
      # set to basic|glftpd|both|none
      - WEBUI_AUTHMODE=both
    # (TEST) host systemd needs priv
    # privileged: true
    # uncomment to use host instead of bridge
    # network_mode: host

  #dev-glftpd:
  #  profiles: [dev]
  #  image: docker-glftpd:latest
  #  ports:
  #    - "1337:1337"
  #  ulimits:
  #    nofile:
  #      soft: 1024
  #      hard: 1024
  #  container_name: glftpd
  #  hostname: glftpd
  # mount ./glftpd
  # volumes:
  #   - /home/silver/dev/docker-glftpd/glftpd/site:/glftpd/site:rw
  #   - /home/silver/dev/docker-glftpd/glftpd/glftpd.conf:/glftpd/glftpd.conf
  #   - /home/silver/dev/docker-glftpd/glftpd/etc:/glftpd/etc
  #   - /home/silver/dev/docker-glftpd/glftpd/ftp-data/users:/glftpd/ftp-data/users
  #   - /home/silver/dev/docker-glftpd/glftpd/ftp-data/groups:/glftpd/ftp-data/groups
  #   - /home/silver/dev/docker-glftpd/glftpd/sitebot:/glftpd/sitebot

  # workaround docker compose profiles

  glftpd:
    profiles: ['SKIP']
    image: ghcr.io/silv3rr/docker-glftpd:latest
    container_name: skip-glftpd
  web:
    profiles: ['SKIP']
    image: ghcr.io/silv3rr/docker-glftpd-web:latest
    container_name: skip-glftpd-web

  local-glftpd:
    image: docker-glftpd:latest
    container_name: glftpd
  local-web:
    image: docker-glftpd-web:latest
    container_name: skip-local-web
